---
title: 虎事小程序
abstract: '欢迎来到我的博客, 这是一篇加密文章。'
message: 请输入密码后按回车键
date: 2018-08-19 17:45:23
tags: 
	- 微信小程序
copyright: Flutter
password:
---
童年中的趣事是最最珍贵的。小时候，我们因为幼小无知而闹出了许多笑话，打开记忆的匣门，童年趣事便接踵而来。

做梦找到厕所，醒来尿床了

小时候穿着裆裤时，跟着小女孩跳皮筋

撒尿和泥，还玩的不亦乐乎

纠结自己要上清华还是北大，长大后发现想多了
<!-- more -->
用笔在自己胳膊上画手表，还舍不得洗掉

用放大镜烤蚂蚁（小时候居然那么残忍……）

老爸骑28自行车带我上街，忘了我已经先坐在后座上，偏腿上车，我就飞了出去…

听着这么一段小故事，或许都发现了这些虎事很有趣。



###  功能展示
1. 首页-视频播放 （同时只能播放一个视频特性）
2. 点赞
3. 分享
4. 回复 （二级页面尚未完善）

### 知识总结
##### 1. 首页-视频播放 （实现统一时刻只能播放一个视频）
解决思路：无非就是找一个标识，作为全局变量去记录上次播放的视频。也可以使用循环的方式去实现，不过循环的方式非常的不友好，随着分页数据的加载回导致程序越来越慢！

方案实时：我使用的是** vuex **,不过也可以采取 ** Storage ** 本地存储的方式。

```javascript
handleVideoPlay() {
        if (!this.playFlag) {
          this.ajaxVideoClick()
        }
        this.playFlag = true;
        const videoCtx = wx.createVideoContext('video-'+this.video.id)
        videoCtx.play()
        //用store定义的变量去判断 
        if(this.videoPlayId === -1){
          // 调用，修改 store中的 videoPlayId 值
          this[VideoPlayId](this.video.id)
          return false
        }
        const videoCtx1 = wx.createVideoContext('video-'+this.videoPlayId)
        videoCtx1.pause()
        this[VideoPlayId](this.video.id)
        // videoCtx.requestFullScreen()
      },
```

##### 2. 分享功能

小程序如果想对外分享，必须在 page 里面定义 onShareAppMessage 函数，来配置页面分享转发相关的信息。

*   只有定义了此事件处理函数，右上角菜单才会显示 “转发” 按钮
*   用户点击转发按钮的时候会调用
*   此事件需要 return 一个 Object，用于自定义转发内容

一个页面可能会有多个分享，可以由插入的参数options来判断具体是由哪个位置进行分享，从而做不同的逻辑判断。

不过在mpvue中，需要把 onShareAppMessage  函数写在 export  default { } 根节点中，与 methods方法通级。

```javascript
 onShareAppMessage(res) {
        return {
          title: '虎事小程序-' + this.video.auther,
          path: this.detaiUrl,
          imageUrl: this.video.img,
          success: function (shareTickets) {
            console.info(shareTickets + '成功');
            // 转发成功
          },
          fail: function (res) {
            console.log(res + '失败');
            // 转发失败
          },
          complete:function(res){
            // 不管成功失败都会执行
          }
        }
      }
```
##### 3. 带参数跳转

在微信小程序中，跳转有普通导航跳转和tabar跳转。在mpvue框架中进行跳转可以使用 ** a 标签  **去实现，也可以使用 ** wx.navigateTo()  **。

```javascript
// 跳转
wx.navigateTo({ url: 'pages/detail/main?id'+this.video.id})

// 目的页面，参数的接收
this.videoId = this.$root.$mp.query.id
```
##### 4. 使用 scss 书写css

首先需要安装node-scss 和 scss-loader

```
 npm install scss-loader --save-dev
 npm install node-scss --save-dev
```
安装完毕就可以这样书写css代码了

```html
<style lang='scss' scoped>
  .video {
    margin-bottom: 10px;
    overflow: hidden;
    .video-img {
      overflow: hidden;
      width: 100%;
    }
 }
</style>
```
如果安装完，** <style lang='scss' scoped></style> ** 嵌套的代码，不智能提示，及 ** {}** 有红色波浪线警告，可以采用如下解决方案。

在VsCode编辑器中，点击 文件-首选项-设置 增加一下几行配置即可。

```
"files.associations": {
	"*.css": "scss"
}
```
##### 5.mpvue中如何使用vuex

在pages根目录下创建stores的目录，并且新建 3个文件

```
index.js
mutation-types.js
mutations.js
```

```javascript
// mutation-types.js

// 获取上次播放ID 用于结束上次播放的视频
export const VideoPlayId = 'VideoPlayId'

// 获取微信用户信息 存有 openID
export const UserInfor = 'UserInfor'
```

```javascript
// mutations.js

import { VideoPlayId, UserInfor } from './mutation-types'

export default {
    [VideoPlayId](state, v) {
        state.videoPlayId = v
    },
    [UserInfor](state, v) {
        state.userInfo = v
    }
}
```

```javascript
// index.js

import Vue from 'vue'
import Vuex from 'vuex'

import mutations from './mutations'

Vue.use(Vuex)

const state = {
    videoPlayId: -1,
    userInfo: {}
}

export default new Vuex.Store({
    state,
    mutations
})
```
绑定Store 到mpvue

```javascript
import Vue from 'vue'
import App from './App'

// 导入Store
import Store from './stores'

Vue.config.productionTip = false
App.mpType = 'app'

// 绑定
Vue.prototype.$store = Store

const app = new Vue(App)
app.$mount()
```
在使用的地方，需要吧state定义的变量，及触发的方法导出。

```javascript
<template>
  <div>
    <button :class="{logged: isLogged}" 
			open-type="getUserInfo" :lang="zh_CN" 
			@click="doLogin"
	>获取用户信息</button>
  </div>
</template>

<script>

// ---开始 vuex 
import { mapState, mapMutations } from 'vuex'
import { UserInfor } from '@/stores/mutation-types'
// ---结束 vuex

import { get, showSuccess, showModal } from '@/utils/index'
import qcloud from 'wafer2-client-sdk'
import config from './../../config'

export default {
  data () {
    return {
    }
  },

  computed:{
    // --- 导出 state 定义的 userInfo 变量
    ...mapState([
      'userInfo'
    ]),
    isLogged () {
      return !!this.userInfo['openId'];
    }
  },
  methods: {
    /* --- 导出 Mutations 定义的 UserInfor变量用来，
		   修改Store.state的userInfo值 */
    ...mapMutations([
      UserInfor
    ]),
    doLogin(){
      qcloud.login({
        success: res => {
		  // 调用Store 方法去修改
          this[UserInfor](res)
          // this.userInfo // 可以 直接访问
        },
        fail: err => {
          this[UserInfor]({})
          showModal('登录错误')
        }
      })
    }
  }
}
</script>

<style scoped>
.logged{
  display: none;
}
</style>

```



### 作品展示

{% asset_img 1.png 260 点赞页面 %}
{% asset_img 2.png 260 播放页 %}
{% asset_img 3.png 260 已点赞页面 %}
{% asset_img 4.png 260 首页 %}
{% asset_img 5.png 260 分享页面 %}
